name: Release Debian Package

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.extract-metadata.outputs.version }}
      package-name: ${{ steps.extract-metadata.outputs.name }}
      description: ${{ steps.extract-metadata.outputs.description }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Extract metadata using Cargo CLI
        id: extract-metadata
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Extract metadata once
          CARGO_METADATA=$(cargo metadata --format-version 1 --no-deps --quiet)
          CARGO_VERSION=$(echo "$CARGO_METADATA" | jq -r '.packages[0].version')
          CARGO_NAME=$(echo "$CARGO_METADATA" | jq -r '.packages[0].name')
          CARGO_DESCRIPTION=$(echo "$CARGO_METADATA" | jq -r '.packages[0].description')

          # Extract version from tag for validation
          TAG_VERSION="${{ github.ref_name }}"; TAG_VERSION="${TAG_VERSION#v}"

          # Validate version match
          if [[ "$CARGO_VERSION" != "$TAG_VERSION" ]]; then
            echo "Warning: Cargo.toml version ($CARGO_VERSION) doesn't match tag version ($TAG_VERSION)"
            echo "Using tag version: $TAG_VERSION"
            VERSION="$TAG_VERSION"
          else
            echo "Version validation passed: $CARGO_VERSION"
            VERSION="$CARGO_VERSION"
          fi

          # Get APT-specific description
          APT_DESC=$(grep -A 2 '\[package\.metadata\.apt\]' Cargo.toml | grep 'repository-description' | sed 's/repository-description = "\(.*\)"/\1/' || echo "${CARGO_DESCRIPTION} APT Repository")
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "name=${CARGO_NAME}" >> $GITHUB_OUTPUT
          echo "description=${APT_DESC}" >> $GITHUB_OUTPUT
          echo "Extracted metadata: Name=${CARGO_NAME}, Version=${VERSION}, Description=${APT_DESC}"

      - uses: Swatinem/rust-cache@v2
        with:
          save-if: true

      - name: Cache cargo binaries
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-tools

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y libssl-dev pkg-config

      - name: Install cargo-deb (cached)
        run: |
          command -v cargo-deb >/dev/null || cargo install cargo-deb --locked

      - name: Build release binary
        run: cargo build --release

      - name: Build .deb package
        run: cargo deb

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: target/debian/*.deb

  publish:
    name: Publish Release & APT Repository
    runs-on: ubuntu-22.04
    needs: build
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Download .deb package
        uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: deb-files

      - name: Setup APT Repository
        uses: ./.github/actions/setup-apt-repo
        with:
          package-name: ${{ needs.build.outputs.package-name }}
          package-description: ${{ needs.build.outputs.description }}
          deb-files-path: deb-files
          output-path: apt-repo
          gpg-private-key: ${{ secrets.GNUPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GNUPG_PASSPHRASE }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: deb-files/*.deb
          name: Release ${{ needs.build.outputs.version }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## ${{ needs.build.outputs.package-name }} v${{ needs.build.outputs.version }}
            
            ### Installation

            #### Direct Download
            Download the `.deb` package and install:
            ```bash
            sudo dpkg -i clean-repo_${{ needs.build.outputs.version }}_amd64.deb
            ```
            
            #### APT Repository
            Add the APT repository for automatic updates:
            ```bash
            curl -s https://repo.msaeedsaeedi.com/clean-repo/key.asc | sudo apt-key add -
            echo "deb https://repo.msaeedsaeedi.com/clean-repo stable main" | sudo tee /etc/apt/sources.list.d/clean-repo.list
            sudo apt update
            sudo apt install clean-repo
            ```

      - name: Deploy APT Repository to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          destination_dir: clean-repo
          cname: repo.msaeedsaeedi.com
          keep_files: true
