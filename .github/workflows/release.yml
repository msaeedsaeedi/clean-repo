name: Release Debian Package

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y libssl-dev pkg-config dpkg-dev build-essential gpg
          cargo install cargo-deb

      - name: Update version in Cargo.toml
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml

      - name: Build Rust binary and .deb package
        run: |
          cargo build --release
          cargo deb

      - name: Copy .deb to workspace
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cp target/debian/clean-repo_${VERSION}_amd64.deb ./clean-repo_${VERSION}_amd64.deb

      - name: Generate APT repository
        run: |
          mkdir -p apt-repo/dists/stable/main/binary-amd64
          mkdir -p apt-repo/pool/main
          cp clean-repo_*.deb apt-repo/pool/main/
          cp install.sh apt-repo/
          cd apt-repo
          dpkg-scanpackages --arch amd64 pool/ /dev/null > dists/stable/main/binary-amd64/Packages
          gzip -9c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz
          cd dists/stable
          apt-ftparchive -o APT::FTPArchive::Release::Suite=stable -o APT::FTPArchive::Release::Codename=stable release . > Release

      - name: Sign Release file (Optional)
        env:
          GNUPG_PRIVATE_KEY: ${{ secrets.GNUPG_PRIVATE_KEY }}
          GNUPG_PASSPHRASE: ${{ secrets.GNUPG_PASSPHRASE }}
        run: |
          if [ -n "$GNUPG_PRIVATE_KEY" ]; then
            echo "$GNUPG_PRIVATE_KEY" | gpg --batch --import
            cd apt-repo/dists/stable
            gpg --batch --yes --pinentry-mode loopback --passphrase "$GNUPG_PASSPHRASE" \
                --detach-sign --armor -o Release.gpg Release
            gpg --batch --yes --pinentry-mode loopback --passphrase "$GNUPG_PASSPHRASE" \
                --clearsign -o InRelease Release
             cd ../../..
             gpg --armor --export > apt-repo/key.asc
          fi

      - name: Deploy to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: clean-repo_*.deb
          draft: false
          prerelease: false

      - name: Deploy APT repo to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          destination_dir: clean-repo
          cname: repo.msaeedsaeedi.com
          keep_files: true
